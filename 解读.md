# TG 自动消息机器人项目解读

## 1. 项目全貌
- **定位**：基于 Telegram Bot API 的轻量广播系统，目前处于 Stage 1，核心是通过命令行触发模板广播，支持 dry-run 预览。
- **目标**：满足 5 个以内群/频道/私聊的定时或手动通知，推送量 < 100/日，易扩展到后续阶段（调度、后台、日志）。
- **基础设施**：Poetry 管理依赖，SQLite + SQLModel 负责存储，FastAPI + Vue3 提供基础的可视化界面雏形，Dockerfile / docker-compose 辅助部署。
- **参考资料**：《需求.txt》定义阶段目标与扩展路线；`USAGE.md` 给出操作指南；`step2.md` 提供下一阶段（自动调度）构想。

## 2. 主要运行形态
1. **命令行广播**：`poetry run python -m app.bot.main broadcast --template <name> --chat-id <id> [--dry-run]`，通过模板发送，支持覆盖文本。
2. **数据库初始化**：`poetry run python -m app.bot.main init-db` 或直接运行 `app.db.session` 创建 `MessageTemplate`、`Chat` 表。
3. **可视化界面**：`python run_backend.py` 启动 FastAPI + Vue3 仪表盘，查看模板、批量发送或删除。
4. **示例脚本**：`examples/write_pending_message.py` 演示如何通过 `TemplateService` 写入模板。

## 3. 目录结构与关注点
```
app/
  config.py          # 载入并缓存 .env 配置
  db/                # SQLModel 模型定义与 Session 工具
  services/          # 业务服务层（模板 CRUD 等）
  bot/               # Telegram 机器人 CLI、广播逻辑及占位模块
  admin/             # 后台占位（未来接入 FastAPI）
visualize/           # FastAPI 可视化 API + Vue3 前端
examples/            # 模板写入示例脚本
data/                # SQLite 数据文件与迁移脚本
tests/               # pytest 覆盖配置、服务与广播
```
其余根目录文件中，`README.md`/`USAGE.md` 提供快速上手说明，`Dockerfile` 与 `docker-compose.yml` 支持容器化部署，`需求.txt`、`step2.md` 记录需求与路线。

## 4. 核心模块解析
### 4.1 配置层：`app/config.py`
- 使用 `python-dotenv` 载入 `.env`，`Settings` dataclass 存放 `BOT_TOKEN`、`DATABASE_URL`、`TIMEZONE`。
- 通过 `lru_cache` 缓存配置实例，`reload_settings()` 支持测试或动态刷新。

### 4.2 数据访问层：`app/db`
- `models.py`：定义两张核心表
  - `MessageTemplate`：模板内容、版本号、解析模式、发送状态、时间戳。
  - `Chat`：维护目标 chat 信息（类型、标题、是否活跃等）。
- `session.py`：按配置懒加载并缓存 SQLModel Engine，提供 `init_db()` 建表、`session_scope()` 上下文管理器，以及测试用 `reset_engine()`。

### 4.3 服务层：`app/services/templates.py`
- `TemplateService`
  - `create_template()`：存在即更新版本号、重置 `was_sent`/`sent_at`
  - `get_template()` / `get_template_by_id()`：不存在时抛出 `TemplateNotFoundError`
  - `list_templates()`：按 `updated_at` 倒序，可筛除已发送模板
  - `mark_templates_sent()` / `delete_templates()` / `delete_template()`：批量/单条操作
- `touch_template()`：刷新更新时间，供更新流程调用。

### 4.4 机器人广播：`app/bot`
- `broadcast.py`
  - `send_manual_broadcast()`：异步逻辑，确保初始化数据库后，读取模板内容，支持 dry-run 或通过 `Bot.send_message()` 发送。
  - `run_manual_broadcast()`：同步封装，供 CLI 使用并处理缺失模板的异常提示。
- `main.py`
  - 构建 CLI，提供 `init-db` 与 `broadcast` 子命令，dry-run 时输出预览文本，否则告知发送结果。
- `rate_limit.py`：定义全局/单 chat 间隔默认值（Stage 2 接入时使用）。
- `handlers.py` / `scheduler.py`：保留 NotImplemented，占位未来的指令注册、调度功能。

### 4.5 后台占位：`app/admin`
- `create_admin_app()` 与 `PlaceholderView` 提示 Stage 3 才会实现完整后台。

### 4.6 可视化 API：`visualize/api.py`
- FastAPI 应用，启动时执行 `init_db()`，并开放以下接口：
  - `GET /`：返回前端 `index.html`
  - `GET /api/templates`：列出模板，可传 `include_sent`
  - `GET /api/chats`：读取活跃 chat 列表
  - `POST /api/templates/send`：对选定模板与 chat 批量发送（内部循环调用 `send_manual_broadcast`，发送成功后标记已发送）
  - `POST /api/templates/delete`：批量删除模板
- 静态资源位于 `visualize/frontend/index.html`，使用 Vue3 + fetch API 显示模板列表、选择 chat、批量发送/删除，并带有仪表盘切换。

## 5. 数据模型与存储
- SQLite 文件默认位于 `data/app.db`，`data/append_column.py` 提供简单迁移示例（为模板表追加 `was_sent`、`sent_at` 列）。
- 模板记录通过 `version` 与时间戳区分历史版本，`was_sent/sent_at` 便于界面显示发送状态。
- 未来规划（`step2.md`）建议新增 `pending_messages`、`deliveries` 等表以支撑自动调度与日志。

## 6. 运行与部署
### 6.1 环境准备
- Python 3.11 + Poetry 安装依赖（`poetry install`）。
- 复制 `.env.example` → `.env`，填充 Bot Token、数据库 URL、时区。

### 6.2 本地运行
- **CLI 测试**：`poetry run python -m app.bot.main init-db`；随后创建模板并 Dry-run 广播。
- **API + 前端**：`python run_backend.py --reload`（默认监听 `127.0.0.1:8000`，会自动打开 `/ui/`）。

### 6.3 Docker
- `docker compose up`：同时启动 bot 与 admin（admin 目前仍为占位）。
- Dockerfile 使用多阶段安装 Poetry 依赖，默认入口执行机器人 CLI。

## 7. 依赖与测试体系
- 依赖集中在 `pyproject.toml`：包括 `python-telegram-bot`、`fastapi`、`sqlmodel`、`apscheduler`（未来调度）、`loguru`（预留日志）等。
- 测试：`pytest` + `pytest-asyncio` + 自定义夹具。
  - `test_sanity.py`：验证配置覆盖与限速默认值。
  - `test_templates.py`：覆盖模板 CRUD、标记发送、删除与异常处理。
  - `test_broadcast.py`：dry-run 返回、真实发送时调用 Telegram 客户端（通过 monkeypatch 伪造 Bot）。
- `tests/conftest.py` 提供 `temp_env`、`settings` 夹具，使用临时 SQLite 文件并重置配置缓存。

## 8. 交互流程示意
1. 运营人员/脚本通过 `TemplateService` 或 API 写入模板。
2. CLI 或 Web 界面选择模板 + chat，调用 `send_manual_broadcast()`。
3. 成功发送后，模板状态更新为已发送，前端刷新即可展示发送时间。
4. 若处于 dry-run，系统不会调用 Telegram API，仅返回预览结果。

## 9. 后续扩展方向（摘自 `需求.txt`、`step2.md`）
- 引入调度器（APScheduler 或 PTB JobQueue）实现定时/批量投放，并记录发送日志。
- 扩展数据库以支持 `pending_messages`、`deliveries` 等队列机制。
- 接入 FastAPI 后台，提供模板管理、队列监控、历史回溯。
- 增加强化限流、重试策略、Webhook 指令处理等运营能力。

## 10. 现状总结
- **已实现**：配置管理、模板 CRUD + 状态、手动广播、基础测试、可视化面板原型、Docker/Poetry 脚手架。
- **进行中/待实现**：Telegram 指令处理、调度任务、后台实际业务、发送日志持久化。
- **适用场景**：小规模运营广播、内部通告、日常简报；为后续自动化扩容打下基础。

> 建议后续在完成 Stage 2 前，优先完善模板写入流程（REST/后台）、自动调度、以及发送日志，以满足“自动挑选内容并群发”的闭环。
